@using SkipperModels
@using SkipperModels.Common
@using SkipperModels.Entities
@using SkipperModels.Models
@using SkipperModels.InputModels
@using SkipperWeb.ApiClients
@using SkipperWeb.Components.Pages.Entities.New

@page "/slips/new"

<NewModelView TInputModel="SlipInputModel"
              TModel="SlipModel"
              TEntity="SlipEntity"
              TClient="SlipClient"
              TClientConfig="SlipClientConfig"
              ModelDisplayName="Slip"
              PageRoute="slips">
    <MudGrid Spacing="3">
        <MudItem xs="12" md="4">
            <MudTextField Label="Slip Number"
                          @bind-Value="context.SlipNumber"
                          For="() => context.SlipNumber"
                          Variant="Variant.Outlined"/>
        </MudItem>
        <MudItem xs="12" md="8">
            <MudSelect Label="Classification"
                       T="SlipClassificationInputModel"
                       @bind-Value="context.SlipClassification"
                       For="() => context.SlipClassification"
                       Variant="Variant.Outlined">
                @foreach (SlipClassificationInputModel model in _slipClassifications)
                {
                    <MudSelectItem T="SlipClassificationInputModel" 
                                   Value="model">
                        <MudStack Row AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.caption">@model.Name</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Tertiary">|</MudText>
                            <MudText Typo="Typo.caption">Base Price: @model.BasePrice.ToString("C")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Tertiary">|</MudText>
                            <MudText Typo="Typo.caption">@($"{model.MaxLength:F} x {model.MaxBeam:F}")</MudText>
                        </MudStack>
                    </MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudTextField Label="Location Code"
                          @bind-Value="context.LocationCode"
                          For="() => context.LocationCode"
                          Variant="Variant.Outlined"/>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect Label="Status"
                       @bind-Value="context.Status"
                       For="() => context.Status"
                       Variant="Variant.Outlined">
                @foreach (SlipStatusEnumeration slipStatus in SlipStatusEnumeration.GetAll())
                {
                    <MudSelectItem Value="@slipStatus.SlipStatus">@slipStatus.DisplayName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
    </MudGrid>
</NewModelView>

@code {

    [Inject]
    public required SlipClassificationClient SlipClassificationClient { get; set; }

    private IEnumerable<SlipClassificationInputModel> _slipClassifications = [];
    
    protected override async Task OnInitializedAsync()
    {
        var modelResults = await SlipClassificationClient.GetByPage(new PagedQuery() { PageSize = 100 });

        if (!modelResults.Success || modelResults.Value is null) throw new Exception("Could not load slip classifications");
        if (modelResults.Value.HasNextPage) throw new Exception("Too many slip classifications for the drop down page!");

        _slipClassifications = modelResults.Value.Items
            .Select(x => new SlipClassificationInputModel()
            {
                Name = x.Name,
                Description = x.Description,
                BasePrice = x.BasePrice,
                MaxLength = x.MaxLength,
                MaxBeam = x.MaxBeam,
            });
    }
}